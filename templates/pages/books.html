{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Books</title>
    <!-- FavIcon -->
    <link rel="shortcut icon" href="{% static 'image/favicon.png' %}" type="image/x-icon">
    <!-- REMIX ICONS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.css">
    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <!-- Dark mode CSS -->
    <link rel="stylesheet" href="{% static 'css/dark-mode.css' %}?v=1.0">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="{% static 'css/swiper-bundle.min.css' %}" />
    <style>
        .cart-count, .favorite-count {
            display: inline-block;
            background-color: var(--first-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            text-align: center;
            line-height: 20px;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        .nav__list {
            display: flex;
            align-items: center;
            column-gap: 1.5rem;
            white-space: nowrap;
        }
        
        .nav__item {
            white-space: nowrap;
        }
        
        .nav__link {
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav__logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 2rem;
            padding: 2rem 0;
        }
        
        .book-card {
            background-color: var(--container-color);
            border-radius: 1.25rem;
            padding: 1.5rem 1rem;
            position: relative;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .book-card:hover {
            transform: translateY(-0.5rem);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.15);
        }
        
        .book-card__img {
            max-width: 100%;
            height: 280px;
            object-fit: cover;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .book-card__data {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .book-card__title {
            font-size: var(--h3-font-size);
            font-weight: var(--font-semi-bold);
            color: var(--title-color);
            margin-bottom: 0.5rem;
            font-family: var(--second-font);
        }
        
        .book-card__author {
            font-size: var(--small-font-size);
            color: var(--text-color-light);
            margin-bottom: 0.75rem;
        }
        
        .book-card__prices {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin: 0.5rem 0 1.5rem;
        }
        
        .book-card__price {
            color: var(--first-color);
            font-size: var(--h2-font-size);
            font-weight: var(--font-semi-bold);
        }
        
        .book-card__discount {
            color: var(--text-color);
            text-decoration: line-through;
            font-weight: var(--font-medium);
        }
        
        .book-card__actions {
            position: absolute;
            right: 1rem;
            top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            opacity: 0;
            transform: translateX(10px);
            transition: all 0.3s ease;
        }

        .book-card:hover .book-card__actions {
            opacity: 1;
            transform: translateX(0);
        }
        
        .book-card__actions .button {
            background: white;
            border: none;
            color: var(--title-color);
            font-size: 1.15rem;
            cursor: pointer;
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        }
        
        .book-card__actions .button:hover {
            background-color: var(--first-color);
            color: white;
            transform: scale(1.1);
        }
        
        .book-card__actions .favorite-button.active {
            color: var(--first-color);
        }
        
        .book-card__actions .favorite-button.active:hover {
            background-color: var(--first-color);
            color: white;
        }
        
        .book-card .add-cart-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--first-color), hsl(230, 62%, 66%));
            border: none;
            border-radius: 2rem;
            font-weight: var(--font-semi-bold);
            letter-spacing: 0.5px;
            margin-top: auto;
            padding: 0.85rem 1.5rem;
            color: var(--white-color);
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(77, 108, 225, 0.25);
        }
        
        .book-card .add-cart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(77, 108, 225, 0.35);
        }
        
        .book-card .add-cart-btn:active {
            transform: translateY(0);
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header" id="header">
        <nav class="nav container">
            <a href="{% url 'index' %}" class="nav__logo">
                <i class="ri-book-marked-fill"></i>E-Book
            </a>
            <div class="nav__menu">
                <ul class="nav__list">
                    <li class="nav__item">
                        <a href="#home" class="nav__link">
                            <i class="ri-home-2-line"></i>
                            <span>Home</span>
                        </a>
                    </li>

                    <li class="nav__item">
                        <a href="{% url 'books' %}" class="nav__link">
                            <i class="ri-book-line"></i>
                            <span>Books</span>
                        </a>
                    </li>

                    <li class="nav__item">
                        <a href="#featured" class="nav__link">
                            <i class="ri-star-line"></i>
                            <span>Featured</span>
                        </a>
                    </li>

                    <li class="nav__item">
                        <a href="#discount" class="nav__link">
                            <i class="ri-price-tag-3-line"></i>
                            <span>Discount</span>
                        </a>
                    </li>

                    <li class="nav__item">
                        <a href="{% url 'my_cart' %}" class="nav__link">
                            <i class="ri-shopping-cart-line"></i>
                            <span>My Cart</span>
                            <span class="cart-count">{{ request.user.cart_items.count }}</span>
                        </a>
                    </li>

                    <li class="nav__item">
                        <a href="{% url 'favourites' %}" class="nav__link">
                            <i class="ri-heart-line"></i>
                            <span>Favorites</span>
                            <span class="favorite-count">{{ request.user.favorites.count }}</span>
                        </a>
                    </li>

                    {% if request.user.is_superuser %}
                    <li class="nav__item">
                        <a href="/admin/" class="nav__link">
                            <i class="ri-dashboard-line"></i>
                            <span>Admin Dashboard</span>
                        </a>
                    </li>
                    {% endif %}

                    <li class="nav__item">
                    </li>
                </ul>
            </div>
            <div class="nav__actions">
                <!--search-->
                <i class="ri-search-line search-button" id="search-button"></i>

                <!--logout button -->
                <a href="{% url 'logout' %}" class="logout-button">
                    <i class="ri-logout-box-line" id="logout-button"></i>
                </a>

                <!-- dark mode -->
                <i class="ri-moon-line change-theme" id="theme-button"></i>
            </div>
        </nav>

    </header>

    <!-- Search Form -->
    <div class="search" id="search-content">
        <form action="" class="search__form">
            <i class="ri-search-line search__icon"></i>
            <input type="search" placeholder="Search..." class="search__input" id="search-input">
        </form>
        <!-- <ul id="search-results" class="search__results"></ul> -->
        <i class="ri-close-line search__close" id="search-close"></i>
        <div class="search__results">
            {% for book in books %}
            <div class="search_card" onclick="window.location.href='{% url 'book_details' book.id %}'">
                <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" class="search__img">
                <div class="search_card_text">
                    <h2 class="search__title">{{ book.title }}</h2>
                    <p class="search__author">by {{ book.author }}</p>
                    <p class="search__description">{{ book.description }}</p>
    
                    <div class="search__prices">
                        {% if book.discount_price %}
                        <span class="search__discount">${{ book.price }}</span>
                        <span class="search__price">${{ book.discount_price }}</span>
                        {% else %}
                        <span class="search__price">${{ book.price }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <!-- Main Content -->
    <main class="main">
        <section class="books section">
            <h2 class="section__title">All Books</h2>
            <div class="books-grid container">
                {% for book in books %}
                <article class="book-card">
                    <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" class="book-card__img">
                    <div class="book-card__data">
                        <h2 class="book-card__title">{{ book.title }}</h2>
                        <p class="book-card__author">by {{ book.author }}</p>
                        <div class="book-card__prices">
                            {% if book.discount_price %}
                            <span class="book-card__discount">${{ book.price }}</span>
                            <span class="book-card__price">${{ book.discount_price }}</span>
                            {% else %}
                            <span class="book-card__price">${{ book.price }}</span>
                            {% endif %}
                        </div>
                        <button class="add-cart-btn" onclick="addToCart({{ book.id }}, event)">ADD TO CART</button>
                    </div>
                    <div class="book-card__actions">
                        <button class="button"><i class="ri-search-2-line"></i></button>
                        <button class="button favorite-button {% if book in request.user.favorites.all %}active{% endif %}" 
                                onclick="toggleFavorite({{ book.id }}, this)">
                            <i class="ri-heart-{% if book in request.user.favorites.all %}fill{% else %}line{% endif %} favorite-icon"></i>
                        </button>
                        <a href="{% url 'book_details' book.id %}" class="button">
                            <i class="ri-eye-line"></i>
                        </a>
                    </div>
                </article>
                {% endfor %}
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer__container container grid">
            <div>
                <a href="#" class="footer__logo">
                    <i class="ri-book-3-line"></i>E-Book
                </a>
                <p class="footer__description">The best place to find your next read.</p>
            </div>
    
            <div>
                <h3 class="footer__title">About Us</h3>
                <ul class="footer__links">
                    <li><a href="#" class="footer__link">About Us</a></li>
                    <li><a href="#" class="footer__link">Contact</a></li>
                    <li><a href="#" class="footer__link">Privacy Policy</a></li>
                    <li><a href="#" class="footer__link">Terms of Service</a></li>
                </ul>
            </div>
    
            <div>
                <h3 class="footer__title">Library</h3>
                <ul class="footer__links">
                    <li><a href="#" class="footer__link">Blogs</a></li>
                    <li><a href="#" class="footer__link">Community</a></li>
                    <li><a href="#" class="footer__link">Our Team</a></li>
                    <li><a href="#" class="footer__link">Help Center</a></li>
                </ul>
            </div>
    
            <div>
                <h3 class="footer__title">Contact</h3>
                <ul class="footer__links">
                    <li>
                        <address class="footer__info">
                            Cairo, Egypt <br>
                            Nassr City <br>
                            1234567890 <br>
                        </address>
                    </li>
                    <li>
                        <address class="footer__info">
                            ebook@gmail.com <br>
                            +20 1234567890 <br>
                        </address>
                    </li>
                </ul>
            </div>
    
            <div>
                <h3 class="footer__title">Social</h3>
                <div class="footer__social">
                    <a href="https://www.facebook.com/" target="_blank" class="footer__social-link">
                        <i class="ri-facebook-fill"></i>
                    </a>
                    <a href="https://www.instagram.com/" target="_blank" class="footer__social-link">
                        <i class="ri-instagram-fill"></i>
                    </a>
                    <a href="https://twitter.com/explore" target="_blank" class="footer__social-link">
                        <i class="ri-twitter-fill"></i>
                    </a>
                </div>
            </div>
        </div>
    
        <span class="footer__copy">
            All rights reserved &copy; 2023 <a href="{% url 'index' %}" class="footer__link">E-Book</a>.
        </span>
    </footer>

    <!-- ScrollReveal-->
    <script src="{% static 'js/scrollreveal.min.js' %}"></script>

    <!-- Swiper JS -->
    <script src="{% static 'js/swiper-bundle.min.js' %}"></script>
    
    <!-- Main JS -->
    <script src="{% static 'js/main.js' %}"></script>
    
    <!-- Search JS -->
    <script src="{% static 'js/search.js' %}"></script>

    <script>
        function addToCart(bookId, event) {
            // Prevent any default behavior
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // Find the button that was clicked
            const button = event ? event.target.closest('button') : document.querySelector(`[onclick*="addToCart(${bookId})"]`);
            const originalText = button.innerHTML;
            button.disabled = true;
            button.classList.add('button--loading');
            button.textContent = 'Adding...';
            
            fetch('{% url "add_to_cart" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `book_id=${bookId}&quantity=1`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show success message with animation
                    button.classList.remove('button--loading');
                    button.classList.add('button--success');
                    button.innerHTML = '<i class="ri-check-line"></i> Added';
                    
                    // Update cart count with animation
                    const cartCount = document.querySelector('.cart-count');
                    if (data.cart_count !== undefined && cartCount) {
                        cartCount.textContent = data.cart_count;
                        cartCount.classList.add('bounce');
                        setTimeout(() => cartCount.classList.remove('bounce'), 1000);
                    }
                    
                    // Reset button after delay
                    setTimeout(() => {
                        button.classList.remove('button--success');
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 2000);
                } else {
                    // Show error state
                    button.classList.remove('button--loading');
                    button.classList.add('button--error');
                    button.textContent = 'Failed';
                    setTimeout(() => {
                        button.classList.remove('button--error');
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                button.classList.remove('button--loading');
                button.classList.add('button--error');
                button.textContent = 'Error';
                setTimeout(() => {
                    button.classList.remove('button--error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
            });
            
            return false;
        }

        function toggleFavorite(bookId, button) {
            const icon = button.querySelector('.favorite-icon');
            const isActive = button.classList.contains('active');
            const url = isActive ? '{% url "remove_favorite" %}' : '{% url "add_favorite" %}';
            
            button.disabled = true;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `book_id=${bookId}`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Toggle active state and icon
                    button.classList.toggle('active');
                    icon.classList.toggle('ri-heart-fill');
                    icon.classList.toggle('ri-heart-line');
                    
                    // Update favorites count with animation
                    const favoriteCount = document.querySelector('.favorite-count');
                    if (data.favorite_count !== undefined && favoriteCount) {
                        favoriteCount.textContent = data.favorite_count;
                        favoriteCount.classList.add('bounce');
                        setTimeout(() => favoriteCount.classList.remove('bounce'), 1000);
                    }
                } else {
                    alert(data.message || 'Failed to update favorites');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            })
            .finally(() => {
                button.disabled = false;
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>