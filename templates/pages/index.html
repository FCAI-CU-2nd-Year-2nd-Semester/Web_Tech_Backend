{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- FavIcon -->
    <link rel="shortcut icon" href="{% static 'image/favicon.png' %}" type="image/x-icon">
    <!-- REMIXIONS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.css">
    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=1.1">
    <!-- Dark mode CSS -->
    <link rel="stylesheet" href="{% static 'css/dark-mode.css' %}?v=1.0">
    <!-- swiper css -->
    <link rel="stylesheet" href="{% static 'css/swiper-bundle.min.css' %}" />
    <style>
        .cart-count,
        .favorite-count {
            display: inline-block;
            background-color: var(--first-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            text-align: center;
            line-height: 20px;
            margin-left: 5px;
            vertical-align: middle;
        }

        .nav__list {
            display: flex;
            align-items: center;
            column-gap: 1.5rem;
            white-space: nowrap;
        }

        .nav__item {
            white-space: nowrap;
        }

        .nav__link {
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav__logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Book card styles from books.html */
        .featured__card {
            background-color: var(--container-color);
            border-radius: 1.25rem;
            padding: 1.5rem 1rem;
            position: relative;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .featured__card:hover {
            transform: translateY(-0.5rem);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.15);
        }

        .featured__img {
            max-width: 100%;
            width: 85%;
            height: 280px;
            object-fit: contain;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .featured__title {
            font-size: var(--h3-font-size);
            font-weight: var(--font-semi-bold);
            color: var(--title-color);
            margin-bottom: 0.5rem;
            font-family: var(--second-font);
        }

        .featured__prices {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin: 0.5rem 0 1.5rem;
        }

        .featured__price {
            color: var(--first-color);
            font-size: var(--h2-font-size);
            font-weight: var(--font-semi-bold);
        }

        .featured__discount {
            color: var(--text-color);
            text-decoration: line-through;
            font-weight: var(--font-medium);
        }

        .featured__actions {
            position: absolute;
            right: 1rem;
            top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            opacity: 0;
            transform: translateX(10px);
            transition: all 0.3s ease;
        }

        .featured__card:hover .featured__actions {
            opacity: 1;
            transform: translateX(0);
        }

        .featured__actions button {
            background: white;
            border: none;
            color: var(--title-color);
            font-size: 1.15rem;
            cursor: pointer;
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        }

        .featured__actions button:hover {
            background-color: var(--first-color);
            color: white;
            transform: scale(1.1);
        }

        .featured__actions .favorite-button.active {
            color: var(--first-color);
        }

        .featured__actions .favorite-button.active:hover {
            background-color: var(--first-color);
            color: white;
        }

        .featured__card .button {
            width: 100%;
            background: linear-gradient(135deg, var(--first-color), hsl(230, 62%, 66%));
            border: none;
            border-radius: 2rem;
            font-weight: var(--font-semi-bold);
            letter-spacing: 0.5px;
            margin-top: auto;
            padding: 0.85rem 1.5rem;
            color: var(--white-color);
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(77, 108, 225, 0.25);
        }

        .featured__card .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(77, 108, 225, 0.35);
        }

        .featured__card .button:active {
            transform: translateY(0);
        }

        /* Disable any older styles that might conflict */
        .featured__img-bar-wrapper,
        .featured__action-bar,
        .featured__add-cart,
        .featured__favorite,
        .featured__view {
            display: none;
        }
    </style>
    <title>Library Home</title>
</head>

<body>
    <!-- Header -->
    <header class="header" id="header">
        <nav class="nav container">
            <a href="{% url 'index' %}" class="nav__logo">
                <i class="ri-book-marked-fill"></i>E-Book
            </a>
            <div class="nav__menu">
                <ul class="nav__list">
                    <li class="nav__item">
                        <a href="#home" class="nav__link">
                            <i class="ri-home-2-line"></i>
                            <span>Home</span>
                        </a>
                    </li>

                    <li class="nav__item">
                        <a href="{% url 'books' %}" class="nav__link">
                            <i class="ri-book-line"></i>
                            <span>Books</span>
                        </a>
                    </li>

                    <li class="nav__item">
                        <a href="#featured" class="nav__link">
                            <i class="ri-star-line"></i>
                            <span>Featured</span>
                        </a>
                    </li>

                    <li class="nav__item">
                        <a href="#discount" class="nav__link">
                            <i class="ri-price-tag-3-line"></i>
                            <span>Discount</span>
                        </a>
                    </li>

                    <li class="nav__item">
                        <a href="{% url 'my_cart' %}" class="nav__link">
                            <i class="ri-shopping-cart-line"></i>
                            <span>My Cart</span>
                            <span class="cart-count">{{ request.user.cart_items.count }}</span>
                        </a>
                    </li>

                    <li class="nav__item">
                        <a href="{% url 'favourites' %}" class="nav__link">
                            <i class="ri-heart-line"></i>
                            <span>Favorites</span>
                            <span class="favorite-count">{{ request.user.favorites.count }}</span>
                        </a>
                    </li>

                    {% if request.user.is_superuser %}
                    <li class="nav__item">
                        <a href="/admin/" class="nav__link">
                            <i class="ri-dashboard-line"></i>
                            <span>Admin Dashboard</span>
                        </a>
                    </li>
                    {% endif %}

                    <li class="nav__item">
                    </li>
                </ul>
            </div>
            <div class="nav__actions">
                <!--search-->
                <i class="ri-search-line search-button" id="search-button"></i>

                <!--logout button -->
                <a href="{% url 'logout' %}" class="logout-button">
                    <i class="ri-logout-box-line" id="logout-button"></i>
                </a>

                <!-- dark mode -->
                <i class="ri-moon-line change-theme" id="theme-button"></i>
            </div>
        </nav>

    </header>

    <!-- Search Form -->
    <div class="search" id="search-content">
        <form action="" class="search__form">
            <i class="ri-search-line search__icon"></i>
            <input type="search" placeholder="Search..." class="search__input" id="search-input">
        </form>
        <!-- <ul id="search-results" class="search__results"></ul> -->
        <i class="ri-close-line search__close" id="search-close"></i>
        <div class="search__results">
            {% for book in books %}
            <div class="search_card" onclick="window.location.href='{% url 'book_details' book.id %}'">
                <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" class="search__img">
                <div class="search_card_text">
                    <h2 class="search__title">{{ book.title }}</h2>
                    <p class="search__author">by {{ book.author }}</p>
                    <p class="search__description">{{ book.description }}</p>

                    <div class="search__prices">
                        {% if book.discount_price %}
                        <span class="search__discount">${{ book.price }}</span>
                        <span class="search__price">${{ book.discount_price }}</span>
                        {% else %}
                        <span class="search__price">${{ book.price }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <!--======================= MAIN =================-->
    <main class="main">
        <!--============================= Home ======================-->
        <section class="home section" id="home">
            <div class="home__container container grid">
                <div class="home__data">
                    <h1 class="home__title">
                        Welcome to Our Library <br> E-Books
                    </h1>
                    <p class="home__description">
                        Discover a world of knowledge and adventure with our extensive collection of e-books. From
                        bestsellers to hidden gems, we have something for every reader. Start your reading journey
                        today!
                    </p>
                    <a href="{% url 'books' %}" class="button">Explore Now</a>
                </div>
                <!-- <div class="background">
                        <img src="assets/img/Background.png" alt="background" class="home__background">
                    </div> -->
                <div class="home__images">
                    <div class="home__swiper swiper">
                        <div class="swiper-wrapper">
                            <article class="home__article swiper-slide">
                                <img src="{% static 'image/home-book-1.png' %}" alt="image" class="home__img">
                            </article>
                            <article class="home__article swiper-slide">
                                <img src="{% static 'image/home-book-2.png' %}" alt="image" class="home__img">
                            </article>
                            <article class="home__article swiper-slide">
                                <img src="{% static 'image/home-book-3.png' %}" alt="image" class="home__img">
                            </article>
                            <article class="home__article swiper-slide">
                                <img src="{% static 'image/home-book-4.png' %}" alt="image" class="home__img">
                            </article>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!--===================== Services =================================-->
        <section class="services section">
            <div class="services__container container grid">
                <article class="services__card">
                    <i class="ri-truck-line"></i>
                    <h3 class="services__title">Free Shipping</h3>
                    <p class="services__description">Order More than $100</p>
                </article>

                <article class="services__card">
                    <i class="ri-lock-line"></i>
                    <h3 class="services__title">Secure payment</h3>
                    <p class="services__description">100% Secure Payment</p>
                </article>

                <article class="services__card">
                    <i class="ri-customer-service-2-line"></i>
                    <h3 class="services__title">24/7 Support</h3>
                    <p class="services__description">Call us anytime</p>
                </article>
            </div>
        </section>

        <!--======================= Featured =================-->
        <section class="featured section" id="featured">
            <h2 class="section__title">
                Featured Books
            </h2>
            <div class="featured__container container">
                <div class="featured__swiper swiper">
                    <div class="swiper-wrapper">
                        {% for book in books|slice:':5' %}
                        <article class="featured__card swiper-slide">
                            <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" class="featured__img">
                            <h2 class="featured__title">{{ book.title }}</h2>
                            <div class="featured__prices">
                                {% if book.discount_price %}
                                <span class="featured__discount">${{ book.price }}</span>
                                <span class="featured__price">${{ book.discount_price }}</span>
                                {% else %}
                                <span class="featured__price">${{ book.price }}</span>
                                {% endif %}
                            </div>
                            <button type="button" class="button" onclick="addToCart({{ book.id }}, event)">ADD TO
                                CART</button>
                            <div class="featured__actions">
                                <button><i class="ri-search-2-line"></i></button>
                                <button
                                    class="favorite-button {% if book in request.user.favorites.all %}active{% endif %}"
                                    onclick="toggleFavorite({{ book.id }}, this)">
                                    <i
                                        class="ri-heart-{% if book in request.user.favorites.all %}fill{% else %}line{% endif %} favorite-icon"></i>
                                </button>
                                <button onclick="window.location.href='{% url 'book_details' book.id %}'">
                                    <i class="ri-eye-line"></i>
                                </button>
                            </div>
                        </article>
                        {% endfor %}
                    </div>
                    <div class="swiper-button-prev">
                        <i class="ri-arrow-left-s-line"></i>
                    </div>
                    <div class="swiper-button-next">
                        <i class="ri-arrow-right-s-line"></i>
                    </div>
                </div>
            </div>
        </section>
        <!--======================= Discount =================-->
        <section class="discount section" id="discount">
            <div class="discount__container container grid">
                <div class="discount__data">
                    <h2 class="discount__title section__title">
                        Up To 50% Off
                    </h2>
                    <p class="discount__description">
                        Get ready for the biggest sale of the year! Enjoy up to 50% off on selected e-books. Don't miss
                        out on this limited-time offer. Shop now and save big on your favorite titles!
                    </p>
                    <br><br>
                    <a href="{% url 'books' %}" class="button">Shop Now</a>
                </div>
                <div class="discount__images">
                    <img src="{% static 'image/discount-book-1.png' %}" alt="image" class="discount__img-1">
                    <img src="{% static 'image/discount-book-2.png' %}" alt="image" class="discount__img-2">
                </div>
            </div>
        </section>

    </main>
    <!--======================= FOOTER =================-->
    <footer class="footer">
        <div class="footer__container container grid">
            <div>
                <a href="#" class="footer__logo">
                    <i class="ri-book-3-line"></i>E-Book
                </a>
                <p class="footer__description">The best place to find your next read.</p>
            </div>

            <div>
                <h3 class="footer__title">About Us</h3>
                <ul class="footer__links">
                    <li><a href="#" class="footer__link">About Us</a></li>
                    <li><a href="#" class="footer__link">Contact</a></li>
                    <li><a href="#" class="footer__link">Privacy Policy</a></li>
                    <li><a href="#" class="footer__link">Terms of Service</a></li>
                </ul>
            </div>

            <div>
                <h3 class="footer__title">Library</h3>
                <ul class="footer__links">
                    <li><a href="#" class="footer__link">Blogs</a></li>
                    <li><a href="#" class="footer__link">Community</a></li>
                    <li><a href="#" class="footer__link">Our Team</a></li>
                    <li><a href="#" class="footer__link">Help Center</a></li>
                </ul>
            </div>

            <div>
                <h3 class="footer__title">Contact</h3>
                <ul class="footer__links">
                    <li>
                        <address class="footer__info">
                            Cairo, Egypt <br>
                            Nassr City <br>
                            1234567890 <br>
                        </address>
                    </li>
                    <li>
                        <address class="footer__info">
                            ebook@gmail.com <br>
                            +20 1234567890 <br>
                        </address>
                    </li>
                </ul>
            </div>

            <div>
                <h3 class="footer__title">Social</h3>
                <div class="footer__social">
                    <a href="https://www.facebook.com/" target="_blank" class="footer__social-link">
                        <i class="ri-facebook-fill"></i>
                    </a>
                    <a href="https://www.instagram.com/" target="_blank" class="footer__social-link">
                        <i class="ri-instagram-fill"></i>
                    </a>
                    <a href="https://twitter.com/explore" target="_blank" class="footer__social-link">
                        <i class="ri-twitter-fill"></i>
                    </a>
                </div>
            </div>
        </div>

        <span class="footer__copy">
            All rights reserved &copy; 2023 <a href="{% url 'index' %}" class="footer__link">E-Book</a>.
        </span>
    </footer>
    <!--======================= SCROLL UP =================-->
    <!-- ScrollReveal-->
    <script src="{% static 'js/scrollreveal.min.js' %}"></script>
    <script src="{% static 'js/search.js' %}"></script>
    <!-- Swiper JS -->
    <script src="{% static 'js/swiper-bundle.min.js' %}"></script>
    <!-- Main JS -->
    <script src="{% static 'js/main.js' %}"></script>
    <!-- Search JS -->
    <script src="{% static 'js/search.js' %}"></script>
    <script>
        // Remove any existing event listeners from Add to Cart buttons
        document.addEventListener('DOMContentLoaded', () => {
            const buttons = document.querySelectorAll('.button');
            buttons.forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
            });
        });

        function addToCart(bookId, event) {
            // Prevent any default behavior
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }

            // Find the button that was clicked
            const button = event ? event.target : document.querySelector(`[onclick*="addToCart(${bookId})"]`);
            const originalText = button.textContent;
            button.disabled = true;
            button.classList.add('button--loading');
            button.textContent = 'Adding to Cart...';

            fetch('{% url "add_to_cart" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `book_id=${bookId}&quantity=1`
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Show success message with animation
                        button.classList.remove('button--loading');
                        button.classList.add('button--success');
                        button.textContent = 'Added to Cart ✓';

                        // Update cart count with animation
                        const cartCount = document.querySelector('.cart-count');
                        if (data.cart_count !== undefined && cartCount) {
                            cartCount.textContent = data.cart_count;
                            cartCount.classList.add('bounce');
                            setTimeout(() => cartCount.classList.remove('bounce'), 1000);
                        }

                        // Reset button after delay
                        setTimeout(() => {
                            button.classList.remove('button--success');
                            button.textContent = originalText;
                            button.disabled = false;
                        }, 2000);
                    } else {
                        // Show error state
                        button.classList.remove('button--loading');
                        button.classList.add('button--error');
                        button.textContent = data.message || 'Failed to add to cart';
                        setTimeout(() => {
                            button.classList.remove('button--error');
                            button.textContent = originalText;
                            button.disabled = false;
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    button.classList.remove('button--loading');
                    button.classList.add('button--error');
                    button.textContent = 'Error occurred';
                    setTimeout(() => {
                        button.classList.remove('button--error');
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 2000);
                });

            return false;
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function toggleFavorite(bookId, button) {
            const icon = button.querySelector('.favorite-icon');
            const isActive = button.classList.contains('active');
            const url = isActive ? '{% url "remove_favorite" %}' : '{% url "add_favorite" %}';

            button.disabled = true;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `book_id=${bookId}`
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Toggle active state and icon
                        button.classList.toggle('active');
                        icon.classList.toggle('ri-heart-fill');
                        icon.classList.toggle('ri-heart-line');

                        // Update favorites count with animation
                        const favoriteCount = document.querySelector('.favorite-count');
                        if (data.favorite_count !== undefined && favoriteCount) {
                            favoriteCount.textContent = data.favorite_count;
                            favoriteCount.classList.add('bounce');
                            setTimeout(() => favoriteCount.classList.remove('bounce'), 1000);
                        }
                    } else {
                        alert(data.message || 'Failed to update favorites');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                })
                .finally(() => {
                    button.disabled = false;
                });
        }
    </script>
</body>

</html>